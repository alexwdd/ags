<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>购物车-{:config('site.name')}</title>
<meta name="keywords" content="{:config('site.keyword')}">
<meta name="description" content="{:config('site.content')}">
{include file="public:cssjs" /}
<link rel="stylesheet" href="{:RES}/element/index.css">
<style type="text/css">
.person{float: right;}
.person li{display: block; float: left; height: 40px; line-height: 40px; padding: 0 10px; background:#39c4da; margin-right: 10px; margin-top: 10px; color: #fff;}
.person li span{cursor: pointer;}
.person li i{cursor: pointer; margin-left:5px; border-radius: 50%; background: #fff; color: #000; font-size: 12px}
.person li i:hover{background: #f60; color: #fff}
[v-cloak] {display: none;}
</style>
</head>
<body>
{include file="public:header" /}
<div id="app" v-cloak>
    <div class="main" style="margin-bottom: 100px">
        <div class="layui-row">
            <div class="layui-col-xs6"><a href="{:url('cart/index')}" class="tab">单收件人模式</a></div>
            <div class="layui-col-xs6"><a href="{:url('mult/index')}" class="tab act">多收件人模式</a></div>
        </div>

        <div class="empty" v-show="!show"><img src="/app/www/view/common/image/empty.png" /><p>空空如也~</p></div>
        
        <div v-show="show">
            <div class="layui-row">
                <div class="layui-col-xs12">
                    <div class="person" id="person">
                        <li v-for="vo in person"><span class="personTag" @click="editPerson(vo)">{{vo.name}} 邮费${{vo.single}}</span><i class="layui-icon layui-icon-close delBtn" @click="delPerson(vo)"></i></li>
                    </div>
                </div>
            </div>

            <div class="layui-row">
                <div class="layui-col-xs6" style="padding:10px">
                    <div class="layui-card">
                        <div class="layui-card-header">购物车</div>
                        <div class="layui-card-body">
                            <table class="layui-table">
                                <colgroup>
                                <col width="80">
                                <col>
                                <col width="80">
                                <col width="120">                
                                <col width="90">                
                                <col width="60">
                                </colgroup>
                                <thead>                
                                    <tr>
                                        <th></th>
                                        <th>商品</th>
                                        <th>价格</th>
                                        <th style="text-align: center;">总件数</th>
                                        <th style="text-align: center;">剩余数量</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="vo,index in cart">
                                        <td><img :src="vo.goods.picname" style="height: 60px"></td>
                                        <td style="text-align: left;">
                                            <h1 style="font-size: 16px; color: #000">
                                                <span v-if="vo.goods.wuliu!=''">【{{vo.goods.wuliu}}】</span>{{vo.goods.name}}{{vo.extends}}
                                            </h1>
                                            <p v-for="s in vo.server">{{s.name}} ${{s.price}}</p>
                                        </td>
                                        <td>{{vo.goods.price}}</td>
                                        <td>
                                            <div class="numberAction">
                                                <span class="set" @click="setCartNumber(index,'dec')">-</span>
                                                <span>{{vo.number}}</span>
                                                <span class="set" @click="setCartNumber(index,'inc')">+</span>
                                            </div> 
                                        </td>
                                        <td class="checkNumber" style="text-align: center;">{{vo.goodsNumber}}</td>
                                        <td>
                                            <p style="margin-bottom: 5px"><button type="button" class="layui-btn layui-btn-xs" @click="addGoods(vo,1)">添加</button></p>
                                            <p><button type="button" class="layui-btn layui-btn-xs layui-btn-danger" @click="delGoods(vo,1)">删减</button></p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="layui-col-xs6" style="padding: 10px">            
                    <div class="layui-card">
                        <div class="layui-card-header">订单</div>                
                        <div class="layui-card-body">
                            <div class="multSelect">
                                <label>收件人</label>
                                <div id="addressStr" class="layui-elip addressStr">{{address.name}} {{address.mobile}} {{address.province}} {{address.address}}</div>        
                                <button type="button" @click="openAddress" class="layui-btn">选择</button>
                                <button type="button" @click="openAddAddress" class="layui-btn">新增</button>
                            </div>

                            <div class="multSelect">
                                <label>发件人</label>
                                <div id="senderStr" class="addressStr">{{sender.name}} {{sender.mobile}}</div> 
                                <button type="button" @click="openSender" class="layui-btn">选择</button>
                                <button type="button" @click="openAddSender" class="layui-btn">新增</button>
                            </div>                 

                            <div class="mBox">
                                <div class="hd">商品</div>
                                <div class="bd">
                                    <table class="layui-table my-table">
                                        <thead>
                                            <col width="70">
                                            <col>
                                            <col width="80">        
                                        </thead>
                                        <tbody>
                                            <tr v-for="vo in goods">
                                                <td><img :src="vo.picname" style="height: 50px" /></td>
                                                <td>{{vo.name}}{{vo.exts}}</td>
                                                <td>{{vo.number}}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <div class="mBox" id="signBox" v-show="signShow">
                                <div class="hd">订单签名</div>
                                <div class="bd">
                                    <input type="text" maxlength="10" name="sign" id="sign" v-model="sign" class="layui-input" placeholder="请输入您要的签名（必填，中文一个字， 英文不超过10个字母）" />
                                </div>
                            </div>

                            <div class="mBox">
                                <div class="hd">快递选择 <span style="color: #f00">{:config('site.weibo')}</span></div>
                                <div class="bd">
                                    <div class="kuaidi">           
                                        <li v-for="vo in wuliu" @click="getWuliu(vo)" :class="{active:kid==vo.id}">{{vo.name}}</li>
                                    </div>
                                    <div class="kdResult" v-if="kdInfo!=''">
                                        <div class="kdTotle">共 {{kdInfo.number}} 箱 - ${{kdInfo.totalPrice}}</div>
                                        <div class="kdBaoguo">
                                            <li v-if="kdInfo.totalExtend > 0"><div class="goods">偏远地区加收邮费</div><div class="yunfei">${{kdInfo.totalExtend}}</div></li>

                                            <li v-for="vo in kdInfo.baoguo">
                                                <div class="goods">
                                                    <p v-for="f in vo.goods">{{f.goodsNumber}} * {{f.name}}</p>
                                                </div>
                                                <div class="yunfei">
                                                    {{vo.kuaidi}} - 约{{vo.totalWuliuWeight}}kg - ${{vo.yunfei}}
                                                </div>
                                            </li>
                                        </div>
                                    </div>  
                                </div>
                            </div>
                            <hr>
                            <div style="text-align: center;">
                                <button type="button" class="layui-btn layui-btn-lg" @click="saveBaoguo">保存订单</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="payBox">
        <div class="box">
        {gt name="zhekou" value="0"}
        折扣：{$zhekou}&nbsp;&nbsp;&nbsp;&nbsp;
        {/gt}
        账户预存款：${$user.money|number_format=###,2}&nbsp;&nbsp;&nbsp;&nbsp;
        运费总计：$<span id="yunfei">{{yunfei}}</span>&nbsp;&nbsp;&nbsp;&nbsp;
        商品总计<span class="money" id="total">${{total}}</span>
        <input type="hidden" id="orderTotalMoney" v-model="total">
        <button type="button" class="layui-btn layui-btn-lg layui-btn-danger" :class="{'layui-btn-disabled':disable}" @click="jiesuan">去结算</button>
        </div>
    </div>

    <el-dialog title="收件人" :visible.sync="addressSelDig">
        <div class="layui-col-md12">
            <div class="layui-inline" style="width: 200px">
                <input type="text" class="layui-input" v-model="keyword" placeholder="姓名/电话">
            </div>
            <div class="layui-inline">
                <button type="button" @click="search" class="layui-btn">查询</button>
            </div>
        </div>

        <el-table :data="addressData" @row-click="selectAddress">
        <el-table-column property="name" label="姓名" width="100"></el-table-column>
        <el-table-column property="mobile" label="手机" width="150"></el-table-column>
        <el-table-column property="province" label="地区" width="200"></el-table-column>
        <el-table-column property="address" label="地址"></el-table-column>
        </el-table>
        <el-pagination style="margin-top: 10px"
          background
          layout="pager"
          @current-change="handleCurrentChange"
          :total="pageCount">
        </el-pagination>
    </el-dialog>

    <el-dialog title="添加收件人" :visible.sync="addressAddDig">
        
        <form class="layui-form" method="post">
            <div class="layui-form-item">
                <label class="layui-form-label">收件人</label>
                <div class="layui-input-inline">
                    <input type="text" name="name" id="name" lay-verify="required"  placeholder="必填" autocomplete="off" class="layui-input">
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">手机号码</label>
                <div class="layui-input-inline">
                    <input type="number" name="mobile" id="mobile" value="{$user.mobile}" required lay-verify="__mobile" placeholder="必填" autocomplete="off" class="layui-input">
                </div>
            </div>            
            <div class="layui-form-item">
                <label class="layui-form-label">地区</label>
                <div class="layui-input-inline">
                    <select name="province" id="provid" lay-filter="provid">
                        <option value="">请选择省</option>
                    </select>
                </div>
                <div class="layui-input-inline">
                    <select name="city" id="cityid" lay-filter="cityid">
                        <option value="">请选择市</option>
                    </select>
                </div>
                <div class="layui-input-inline">
                    <select name="area" id="areaid" lay-filter="areaid">
                        <option value="">请选择县/区</option>
                    </select>
                </div>
            </div>
            
            <div class="layui-form-item">
                <label class="layui-form-label">详细地址</label>
                <div class="layui-input-block">
                    <input type="text" name="address" lay-verify="required" placeholder="必填" autocomplete="off" class="layui-input">
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">身份证号</label>
                <div class="layui-input-block">
                    <input type="text" name="sn" lay-verify="_cardNo" placeholder="选填" autocomplete="off" class="layui-input">
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">身份证照片</label>
                <div class="layui-input-block">
                    <div class="sn" onclick="uploadImage('front','{:url('upload/image','water=1')}');"><img id="front_src" src="{:RES}/image/sn1.png" /></div>
                    <div class="sn" onclick="uploadImage('back','{:url('upload/image','water=1')}');"><img id="back_src" src="{:RES}/image/sn2.png" /></div>
                </div>
            </div>

            <div class="layui-form-item">
                <div class="layui-input-block">
                    <button class="layui-btn" lay-submit lay-filter="go1" @click="saveAddress">添加</button>
                </div>                    
            </div>
            <input type="hidden" name="front" id="front" >
            <input type="hidden" name="back" id="back" >
        </form>
    </el-dialog>


    <el-dialog title="发件人" :visible.sync="senderSelDig">
        <div class="layui-col-md12">
            <div class="layui-inline" style="width: 200px">
                <input type="text" class="layui-input" v-model="keyword1" placeholder="姓名/电话">
            </div>
            <div class="layui-inline">
                <button type="button" @click="search1" class="layui-btn">查询</button>
            </div>
        </div>
        <el-table :data="senderData" @row-click="selectSender">
        <el-table-column property="name" label="姓名" width="100"></el-table-column>
        <el-table-column property="mobile" label="手机"></el-table-column>
        </el-table>

        <el-pagination style="margin-top: 10px"
          background
          layout="pager"
          @current-change="handleCurrentChange1"
          :total="pageCount">
        </el-pagination>
    </el-dialog>

    <el-dialog title="添加发件人" :visible.sync="senderAddDig">
        
        <form class="layui-form" method="post">
            <div class="layui-form-item">
                <label class="layui-form-label">姓名</label>
                <div class="layui-input-inline">
                    <input type="text" name="name" id="name" lay-verify="required"  placeholder="必填" autocomplete="off" class="layui-input">
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">手机号码</label>
                <div class="layui-input-inline">
                    <input type="number" name="mobile" id="mobile" value="{$user.mobile}" required lay-verify="__mobile" placeholder="必填" autocomplete="off" class="layui-input">
                </div>
            </div> 
            <div class="layui-form-item">
                <div class="layui-input-block">
                    <button class="layui-btn" lay-submit lay-filter="go2" @click="saveSender">添加</button>
                </div>                    
            </div>
        </form>
    </el-dialog>
</div>

{gt name=":config('site.discount')" value="0"}
<div class="zhekou">
    <p>{:config('site.discount')}<span>折</span></p>
</div>
{/gt}

<script>
var is_over = false;
function alert_if_over() {
    if (!is_over){
        return '';
    }
}
window.onbeforeunload = alert_if_over;
</script>
<script src="{:RES}/js/vue.min.js" type="text/javascript" ></script>
<script src="{:RES}/element/index.js"></script>
<script type="text/javascript">
vm = new Vue({
    el : "#app",
    data : {
        show:true,
        total:0.00,
        zhekou:{$zhekou},
        yunfei:0.00,
        person:[],
        cart:[],
        goods:[],        
        
        kid:0,
        kdInfo:[],
        wuliu:[],
        sign:'',
        signShow:false,

        address:'',
        addressSelDig:false,
        addressAddDig:false,
        keyword:'',
        page:1,
        pageCount:0,
        addressData:[],

        sender:'',
        keyword1:'',
        senderSelDig:false,
        senderAddDig:false,
        senderData:[],

        disable:true
    },
    created : function(){
        var that = this;
        $.get('{:url("mult/cart")}',function(res){
            if (res.code==1){
                that.cart = res.body.data;
                that.total = res.body.total;
                that.wuliu = res.body.wuliu;
                if (that.cart.length==0){
                    that.show=false;
                }
            }else{
                layer.alert(res.desc)
            }
        },'json')
    },
    methods: {
        //设置购物车数量
        setCartNumber(index,type){
            var that = this;
            if (type=='inc'){
                that.cart[index]['number']++;
                that.cart[index]['goodsNumber'] = parseInt(that.cart[index]['goodsNumber']) + parseInt(that.cart[index]['goods']['number']);                
            }else{
                if (that.cart[index]['number']<=1 || that.cart[index]['goodsNumber']<that.cart[index]['goods']['number']){
                    return false;
                }
                that.cart[index]['number']--;
                that.cart[index]['goodsNumber'] = parseInt(that.cart[index]['goodsNumber'])- parseInt(that.cart[index]['goods']['number']);
            }
            var load = layer.load(2);
            $.get("{:url('cart/setCartNum')}?number="+that.cart[index]['number']+"&cartID="+that.cart[index]['id']+"&temp="+new Date().getTime(),function(res){
                layer.close(load);
                that.total = res.total                
            },'json');
            that.checkStatus();
        },
        //购物车中商品添加到商品中
        addGoods(info,number){
            if (parseInt(info.goodsNumber) < parseInt(info.goods.step)){
                return false;
            }
            this.setCartGood(info,number,'dec');
            let flag = false;
            for(var i= 0; i<this.goods.length; i++){
                if (info.itemID == this.goods[i]['itemID']){
                    this.goods[i]['number'] += number;
                    this.goods[i]['goodsNumber'] += number * parseInt(info.goods.step);
                    flag = true;
                    break;
                }
            }
            if (!flag){
                goods = {
                    'goodsID':info.goodsID,
                    'itemID':info.itemID,
                    'server':info.server,
                    'number':number,
                    'goodsNumber':number*info.goods.step,
                    'name':info.goods.name,
                    'short':info.goods.short,
                    'picname':info.goods.picname,            
                    'typeID':info.typeID,
                    'exts':info.extends,
                    'flag':info.flag
                }
                this.goods.push(goods);
            }
            this.checkSign();
        },
        //删除已选中的商品
        delGoods(info,number){
            var temp = [];
            for(var i= 0; i<this.goods.length; i++){
                if (info.itemID == this.goods[i]['itemID']){
                    this.goods[i]['number'] -= number;
                    this.goods[i]['goodsNumber'] -= info.goods.step*number;
                    this.setCartGood(info,number,'inc');
                }
                if (this.goods[i]['number']>0){
                    temp.push(this.goods[i]);
                }                
            }
            this.goods = temp;
            this.checkSign();
        },
        checkSign(){
            var total = 0;
            for(var i= 0; i<this.goods.length; i++){
                if(this.goods[i]['flag']==1){
                    total++;
                }       
            }
            if (total>0){
                this.signShow = true;
            }else{
                this.signShow = false;
                this.sign = '';
            }
        },
        checkStatus(){
            var total = 0;
            for(var i= 0; i<this.cart.length; i++){
                total = total + parseInt(this.cart[i]['goodsNumber']);
            } 
            if (total>0){
                this.disable = true;
            }else{
                this.disable = false;
            }
        },
        setCartGood(info,number,type){
            this.kid = 0;
            this.kdInfo = [];

            for(var i= 0; i<this.cart.length; i++){
                if (info.itemID == this.cart[i]['itemID']){
                    if (type=='inc'){ 
                        this.cart[i]['goodsNumber'] += number * parseInt(info.goods.step);
                    }else{
                        this.cart[i]['goodsNumber'] -= number * parseInt(info.goods.step);
                    }                    
                }
            }
        },
        getWuliu(value){
            //获取物流信息
            var that = this;
            if (this.goods.length==0){
                layer.alert("请先添加商品");
                return false;
            }
            if (that.address==''){
                layer.alert("请选择收件人");
                return;
            }
            that.kid = value.id;
            data = {
                'kid':that.kid,
                'goods':JSON.stringify(that.goods),
                'province':that.address.province
            }
            $.post("{:url('mult/getYunfei')}",data,function(res){
                if (res.code==1) {
                    that.kdInfo = res.data;
                    that.kdInfo.number = res.data.baoguo.length;
                }else{
                    layer.alert(res.msg);
                }
            },'json');
        },
        saveBaoguo(){
            //获取物流信息
            var that = this;
            if (this.goods.length==0){
                layer.alert("请先添加商品");
                return false;
            }
            if (that.address==''){
                layer.alert("请选择收件人");
                return;
            }
            if (that.sender==''){
                layer.alert("请选择发件人");
                return;
            }
            if (that.kid==0){
                layer.alert("请选择快递");
                return;
            }
            if(this.signShow){
                if(this.sign =='') {
                    layer.alert("请输入签名，中文1个汉字，英文不超过1个单词");
                    return false;
                }
                if (testChina(this.sign)){
                    if (this.sign.length>1){
                        layer.alert("中文只能1个汉字");
                        return false;
                    }
                }else{
                    if (this.sign.indexOf(' ') >= 0){
                        layer.alert("英文不能超过1个单词");
                        return false;
                    }
                }
            }

            var that = this;
            data = {
                'kuaidi':that.kid,
                'goods':JSON.stringify(that.goods),
                'addressID':that.address.id,
                'sender':that.sender.name+','+that.sender.mobile,
                'intr':'',
                'sign':that.sign
            }
            var load = layer.load(2);
            $.post("{:url('mult/save')}",data,function(res){
                layer.close(load);
                if (res.code==1) {
                    layer.alert("操作成功");
                    that.person = that.person.concat(res.data);
                    that.yunfei = res.data.yunfei;
                    that.formatData();
                    that.checkStatus();
                }else{
                    layer.alert(res.msg);
                }
            },'json');
        },
        jiesuan(){
            if(this.disable){
                return false;
            }

            /*var userMoney = {$user.money};
            var orderMoney = this.total;
            if(userMoney > orderMoney){
                money = orderMoney >= userMoney ? userMoney : orderMoney;
                _html = "订单共【$"+orderMoney+"元】，使用余额【$"+money+"元】";
            }else{
                _html="订单共计【$"+orderMoney+"元】";
            }*/
            let money = parseFloat(this.total)+parseFloat(this.yunfei);
            if (this.zhekou>0){
                money = money * parseFloat(this.zhekou) / 10;
                money = money.toFixed(2);
            }
            _html="订单共计【$"+money+"元】";      
            layer.confirm(
                _html,
                {btn: ['确定','取消']},
                function(){
                    layer.closeAll();
                    var load = layer.load(2);
                    $.post("{:url('mult/doSubmit')}",function(res){
                        layer.close(load);
                        if(res.code == 1){
                            layer.open({
                                type:0, 
                                icon:1,
                                content:res.msg,
                                time:3000,
                                end: function(){
                                    is_over=true;
                                    window.location.href = res.url;
                                } 
                            });
                        }else{
                            layer.alert(res.msg);
                        }
                    },"json")
                }
            )
        },
        editPerson(value){
            var that = this; 
            that.disable = true;
            for(var i= 0; i<that.goods.length; i++){
                for(var j= 0; j<that.cart.length; j++){
                    if (that.goods[i]['itemID'] == that.cart[j]['itemID']){
                        var info = that.cart[j];
                        break;
                    }
                }
                that.setCartGood(info,that.goods[i]['number'],'inc');
            }
            $.post('{:url("mult/getinfo")}',{id:value.personID},function(res){
                if (res.code==1){
                    that.address = res.body.address;
                    that.sender = {name:res.body.data.sender,mobile:res.body.data.senderMobile};
                    var goods = res.body.data.goods;

                    that.goods = [];
                    for(var i= 0; i<goods.length; i++){     
                        for(var j= 0; j<that.cart.length; j++){                            
                            if (goods[i]['itemID'] == that.cart[j]['itemID']){
                                cartInfo = that.cart[j];        
                                number = parseInt(goods[i]['num']);
                                tempGoods = {
                                    'goodsID':cartInfo.goodsID,
                                    'itemID':cartInfo.itemID,
                                    'server':cartInfo.server,
                                    'number':number/cartInfo.goods.step,
                                    'goodsNumber':number,
                                    'name':cartInfo.goods.name,
                                    'short':cartInfo.goods.short,
                                    'picname':cartInfo.goods.picname,            
                                    'typeID':cartInfo.typeID,
                                    'exts':cartInfo.extends,
                                    'flag':cartInfo.flag
                                };    
                                that.goods.push(tempGoods);
                            }
                        }
                    }
                }
            },'json')

            var temp = [];
            for(var i= 0; i<that.person.length; i++){
                if (that.person[i]['personID'] != value.personID){
                    temp.push(that.person[i]);
                }
            }
            that.person = temp;
        },
        delPerson(value){
            var that = this;
            layer.confirm('确认要删除吗？',{
            btn: ['确认','放弃'] //按钮
            }, function(){
                var temp = [];
                for(var i= 0; i<that.person.length; i++){
                    if (that.person[i]['personID'] != value.personID){
                        temp.push(that.person[i]);
                    }
                }
                that.person = temp;
                $.post('{:url("mult/delete")}',{'id':value.personID},function(res){
                    if (res.code==1){
                        var data = res.data.list;
                        for (var i = 0; i < data.length; i++) {
                            itemID = data[i]['itemID'];
                            num = parseInt(data[i]['number']);
                            for(var j= 0; j<that.cart.length; j++){
                                if (itemID == that.cart[j]['itemID']){
                                    that.setCartGood(that.cart[j],num/that.cart[j]['goods']['step'],'inc')
                                }
                            }
                        }
                        that.yunfei = res.data.yunfei;
                        that.disable = true;
                    }
                    layer.closeAll();
                },'json')
            });
        },
        formatData(){
            this.goods = [];
            this.address = '';
            this.sign = '';
            this.signShow = false;
            this.kid = 0;
            this.kdInfo = '';
        },
        handleCurrentChange(v){
            this.page = v;
            this.getAddress();
        },
        search(){
            this.page = 1;
            this.getAddress();
        },
        openAddress(){
            //选择收件人
            this.addressSelDig = true;
            this.getAddress();
        },
        getAddress(){
            //选择收件人
            var that = this;            
            data = {page:that.page,keyword:that.keyword};
            $.post("{:url('mult/selectAddress')}",data,function(res){
                if (res.code==1) {
                    that.addressData = res.data;
                    that.pageCount = res.count;
                }else{
                    layer.alert(res.msg);
                }
            },'json');
        },
        selectAddress(row){
            this.addressSelDig = false;
            this.address = row;
        },
        openAddAddress(){
            this.addressAddDig = true;            
        },
        saveAddress(){
            var that = this;
            layui.use('form', function(){
                var form = layui.form;          
                form.on('submit(go1)', function(data){
                    var load = layer.load(2);                    
                    $.ajax({
                        url:'{:url('address/add')}',
                        method:'post',
                        data:data.field,
                        dataType:'JSON',
                        success:function(res){
                            layer.close(load);
                            that.address = data.field;
                            that.address.id = res.data.id;
                            that.addressAddDig = false;
                        },
                        error:function (data) {
                            layer.close(load);
                            layer.alert("服务器连接失败");
                        }
                    })
                    return false;
                });
            });
        },
        handleCurrentChange1(v){
            this.page = v;
            this.getSender();
        },
        search1(){
            this.page = 1;
            this.getSender();
        },
        openSender(){
            //选择收件人
            this.senderSelDig = true;
            this.getSender();
        },
        getSender(){
            var that = this;            
            data = {page:that.page,keyword:that.keyword1};
            $.post("{:url('mult/selectSender')}",data,function(res){
                if (res.code==1) {
                    that.senderData = res.data; 
                    that.pageCount = res.count; 
                }else{
                    layer.alert(res.msg);
                }
            },'json');
        },
        selectSender(row){
            this.senderSelDig = false;
            this.sender = row;
        },
        openAddSender(){
            this.senderAddDig = true;            
        },
        saveSender(){
            var that = this;
            layui.use('form', function(){
                var form = layui.form;          
                form.on('submit(go2)', function(data){
                    var load = layer.load(2);                    
                    $.ajax({
                        url:'{:url('address/addsender')}',
                        method:'post',
                        data:data.field,
                        dataType:'JSON',
                        success:function(res){
                            layer.close(load);
                            that.sender = data.field;
                            that.sender.id = res.data.id;
                            that.senderAddDig = false;
                        },
                        error:function (data) {
                            layer.close(load);
                            layer.alert("服务器连接失败");
                        }
                    })
                    return false;
                });
            });
        }
    },
    updated : function(){
        var defaults = {
            s1: 'provid',
            s2: 'cityid',
            s3: 'areaid',
            v1: '北京',
            v2: '北京',
            v3: '东城区'
        };
        var $form;
        var form;
        layui.define(['form'], function () {
            form = layui.form;
            $form = $('form');    
            treeSelect(defaults);
        });
        function treeSelect(config) {
            config.v1 = config.v1 ? config.v1 : 110000;
            config.v2 = config.v2 ? config.v2 : 110100;
            config.v3 = config.v3 ? config.v3 : 110101;
            $.each(threeSelectData, function (k, v) {
                appendOptionTo($form.find('select[id=' + config.s1 + ']'), k, v.val, config.v1);
            });
            form.render();
            cityEvent(config);
            areaEvent(config);
            form.on('select(' + config.s1 + ')', function (data) {
                cityEvent(data);
                form.on('select(' + config.s2 + ')', function (data) {
                    areaEvent(data);
                });
            });

            function cityEvent(data) {
                $form.find('select[id=' + config.s2 + ']').html("");
                config.v1 = data.value ? data.value : config.v1;
                $.each(threeSelectData, function (k, v) {            
                    if (k == config.v1) {
                        if (v.items) {
                            $.each(v.items, function (kt, vt) {
                                appendOptionTo($form.find('select[id=' + config.s2 + ']'), kt, vt.val, config.v2);
                            });
                        }
                    }
                });
                form.render();
                config.v2 = $('select[id=' + config.s2 + ']').val();
                areaEvent(config);
            }
            function areaEvent(data) {
                $form.find('select[id=' + config.s3 + ']').html("");
                config.v2 = data.value ? data.value : config.v2;
                $.each(threeSelectData, function (k, v) {
                    if (k == config.v1) {
                        if (v.items) {
                            $.each(v.items, function (kt, vt) {
                                if (kt == config.v2) {
                                    $.each(vt.items, function (ka, va) {
                                        appendOptionTo($form.find('select[id=' + config.s3 + ']'), ka, va, config.v3);
                                    });
                                }
                            });
                        }
                    }
                });
                form.render();
                form.on('select(' + config.s3 + ')', function (data) { });
            }
            function appendOptionTo($o, k, v, d) {
                var $opt = $("<option>").text(k).val(k);
                if (k == d) { $opt.attr("selected", "selected") }
                $opt.appendTo($o);
            }
        }
    }
})

function testChina(v){ 
    var pattern = /^[\u4E00-\u9FA5]{1,500}$/;
    flag = pattern.test(v);
    if(!flag){
        return false;
    }else{
        return true;
    }
}
</script>

<input type="file" id="uploadfile" hidden /> 
<script src="{:RES}/js/data.js" type="text/javascript" charset="utf-8"></script>
</body>
</html>